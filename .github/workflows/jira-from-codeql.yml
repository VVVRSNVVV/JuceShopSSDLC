name: Create Jira Issues from Code Scanning

on:
  workflow_run:
    workflows: ["CodeQL Advanced"]
    types:
      - completed

jobs:
  create_jira_issues:
    runs-on: ubuntu-latest

    steps:
    - name: Download SARIF results
      uses: actions/download-artifact@v4
      with:
        name: codeql-sarif
        path: sarif

    - name: Parse SARIF and create Jira issues
      uses: actions/github-script@v7
      env:
        JIRA_TOKEN: ${{ secrets.JIRA_TOKEN }}
        JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
        JIRA_URL: ${{ secrets.JIRA_URL }}
      with:
        script: |
          const fs = require('fs');
          const axios = require('axios');

          const sarifFiles = fs.readdirSync('sarif').filter(f => f.endsWith('.sarif'));

          for (const file of sarifFiles) {
            const sarif = JSON.parse(fs.readFileSync(`sarif/${file}`, 'utf8'));
            for (const run of sarif.runs) {
              for (const result of run.results) {

                const summary = result.ruleId || "Unknown rule";
                const description = result.message.text || "No message";
                const severity = result.level.toUpperCase();

                console.log(`Creating Jira issue for: ${summary}`);

                const issue = {
                  fields: {
                    project: { key: "TEST" },
                    summary: `[${severity}] ${summary}`,
                    description: description,
                    issuetype: { name: "Bug" }
                  }
                };

                await axios.post(
                  `${process.env.JIRA_URL}/rest/api/3/issue`,
                  issue,
                  {
                    auth: {
                      username: process.env.JIRA_EMAIL,
                      password: process.env.JIRA_TOKEN
                    },
                    headers: { 'Content-Type': 'application/json' }
                  }
                );
              }
            }
          }
